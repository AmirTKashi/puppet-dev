# Puppet master design

The test and development Puppet master has three design goals:

* To simplify common tasks (such as issuing a LetsEncrypt certificate)

* To encourage the use of declarative configuration

* To gently guide developers towards building applications in a way
  that will be amenable to deployment in a production environment.

This approach is not intended to replicate or to replace the
production Puppet manifests.  The production manifests deal with
concerns such as monitoring and high availability that are not
required for a test and development environment.

This approach is intended to make it easy for developers to deploy
their applications in ways that will make it easy to later package and
deploy the application for production.  For example, by providing a
mechanism for deploying a WSGI application by simply specifying the
WSGI entry point in a YAML file, we encourage developers not to
introduce spurious dependencies on a particular mechanism such as
`gunicorn` for running WSGI applications.

## YAML first

Developers should be able to perform all common configuration tasks
solely by editing values in YAML files within the `data` directory.
Most developers should never need to learn how to write a Puppet
manifest.

## Local Puppet repository

Each Puppet master can be configured with a local Puppet repository by
running [`/usr/bin/unipart-puppet-setup`](files/unipart-puppet-setup).
This will default to using a repository name constructed from the
Puppet master's DNS domain.  For example, if the Puppet master's DNS
domain is `foobar.devonly.net` then the default repository name will
be `foobar/puppet`.

The [`unipart-puppet-setup`](files/unipart-puppet-setup) script will
configure an `r10k` webhook so that changes committed to the local
Puppet repository are automatically deployed to the Puppet master.

The local Puppet repository must be cloned from the `puppet-template`
repository, which includes the minimal set of files
(`environment.conf` and a `hiera.yaml` symlink) required to enable
operation as part of this design.

## Shared Puppet repository

To avoid unnecessary deduplication work, there are two Puppet
repositories deployed to the Puppet master:

* The local Puppet repository (as described above) is deployed via
  `r10k` to `/etc/puppetlabs/code/environments`.

* The shared Puppet repository (i.e. this repository) is deployed via
  `r10k` to `/etc/puppetlabs/code/unipart`.

A systemd timer `r10k-deploy.timer` ensures that the copy of this
shared Puppet repository in `/etc/puppetlabs/code/unipart` is kept up
to date even if no changes are being pushed to the local Puppet
repository.

The local Puppet repository in `/etc/puppetlabs/code/environments` is
the only repository as far as the Puppet master is concerned.  The
module and Hiera search paths are configured in `puppet.conf` to
include the relevant parts of the shared Puppet repository as needed.

The upshot is that the shared Puppet repository can be used to deploy
functionality that is likely to be needed across multiple projects.
This avoids the need for the local Puppet repositories to include any
boilerplate code, and allows the shared Puppet repository to be
updated without requiring the local Puppet repository to explicitly
merge changes.

## Puppetfile

Modules within both the local and shared Puppet repositories are
managed by `r10k` according to the definitions in `Puppetfile`.
Modules are automatically updated whenever a repository is updated.

## Hiera

Hiera is configured to provide per-host, per-OS, and common settings.

The hierarchy for the environment layer includes the shared Puppet
repository [`data` directory](../../data/) as well as the local Puppet
repository `data` directory.  This allows the shared Puppet repository
to provide sensible defaults so that these do not need to be
duplicated in each local Puppet repository.

A global Hiera layer exists in the shared Puppet repository's
[`global` directory](../../global/).  This can be used to override any
configuration provided by the environment layer.

The use of encrypted YAML is enabled by default, with a key pair
autogenerated and placed in `/etc/puppetlabs/puppet/keys`.  The
command `/usr/bin/eyaml` is available and is automatically configured
to use the appropriate keys.

## Site manifest

The Puppet master is configured via `default_manifest` to use the
[`site.pp`](../../manifests/site.pp) from the shared Puppet
repository.  This manifest simply delegates to Hiera to identify the
applicable classes.

## Development

Any changes pushed to the `production` branch of this repository will
automatically be deployed within a short time interval to all test and
development Puppet masters.  These changes may, if incorrect, prevent
the Puppet masters from being able to subsequently fetch any fixes
that you make.

You must therefore **never** push non-working code to the `production`
branch of this repository, even on a temporary basis.

To develop changes to this repository:

- Create a development branch with a name exactly matching your
  project name (i.e. the first component of your project's DNS domain
  name)

- While the development branch exists in this repository, the code on
  the development branch will override the code on the `production`
  branch on your project's Puppet master.

  This does not affect the Hiera global layer or `site.pp`: these will
  continue to use the versions in the `production` branch.

- You can use `systemctl restart r10k-deploy` to pull changes from
  your development branch onto your Puppet master without waiting for
  the update timer.

- Once you have finished and tested your changes, rebase and tidy up
  the commit history on your development branch.

- Once you have a clean and linear commit history in your development
  branch of this repository, you may push your changes to the
  `production` branch.

- Delete your development branch from the repository, so that your
  Puppet master reverts to using the `production` branch.
